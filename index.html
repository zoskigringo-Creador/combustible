<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <!-- Configuración para iPhone (PWA) - Crítico para pantalla completa real -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Combustible">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/483/483497.png">

    <title>Calculadora de Combustible</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* Bloquea el "Pull-to-refresh" (Deslizar para actualizar) */
        html, body {
            overscroll-behavior-y: none;
            overscroll-behavior-x: none;
            height: 100%;
            overflow: hidden; /* Controlamos el scroll internamente */
        }
        
        body {
            -webkit-tap-highlight-color: transparent;
            padding-top: env(safe-area-inset-top);
        }

        /* Estilos específicos para impresión/PDF */
        @media print {
            .no-print { display: none !important; }
            body { background: white; color: black; height: auto; overflow: visible; }
            #historyList { overflow: visible; height: auto; }
            .print-only { display: block !important; }
            /* Asegurar que la lista se vea completa al imprimir */
            .overflow-y-auto { overflow: visible !important; height: auto !important; }
        }
        .print-only { display: none; }
    </style>
</head>
<body class="bg-gray-100 flex flex-col font-sans text-gray-800">

    <!-- Header -->
    <div class="bg-blue-600 text-white p-4 pb-8 shadow-lg z-10 sticky top-0 no-print">
        <!-- Reloj y Botones Superiores -->
        <div class="flex justify-between items-start mb-2">
            <div id="clockDisplay" class="text-xs font-mono text-blue-200 bg-blue-800/30 px-2 py-1 rounded">
                --/--/-- --:--:--
            </div>
            <div class="flex gap-2">
                <button onclick="toggleFullScreen()" class="p-2 bg-blue-700 rounded-lg hover:bg-blue-800" aria-label="Pantalla Completa">
                    <i data-lucide="maximize" id="fsIcon" class="w-4 h-4 text-white"></i>
                </button>
                <button onclick="generatePDF()" class="p-2 bg-blue-700 rounded-lg hover:bg-blue-800" aria-label="PDF">
                    <i data-lucide="printer" class="w-4 h-4 text-white"></i>
                </button>
                <button onclick="resetAll()" class="p-2 bg-red-500/80 rounded-lg hover:bg-red-600" aria-label="Reiniciar">
                    <i data-lucide="rotate-ccw" class="w-4 h-4 text-white"></i>
                </button>
            </div>
        </div>

        <!-- Totales -->
        <div class="flex justify-between items-end">
            <div>
                <h1 class="text-xs font-medium text-blue-100 uppercase tracking-wider">Total Litros</h1>
                <div class="flex items-baseline mt-1">
                    <span class="text-4xl font-bold" id="displayTotal">0</span>
                    <span class="text-xl ml-1 text-blue-200">Lts</span>
                </div>
            </div>
            <div class="text-right">
                <p class="text-xs text-blue-200">Móviles</p>
                <span class="text-2xl font-semibold" id="countDisplay">0</span>
            </div>
        </div>
    </div>

    <!-- Título solo para PDF -->
    <div class="print-only p-4 text-center">
        <h1 class="text-2xl font-bold">Reporte de Carga de Combustible</h1>
        <p id="printDate" class="text-gray-500"></p>
    </div>

    <!-- Área de Input (No se imprime) -->
    <div class="flex-none p-4 -mt-4 bg-white rounded-t-2xl shadow-sm z-20 relative no-print">
        <div class="grid grid-cols-2 gap-4">
            <div class="space-y-1">
                <label class="text-xs font-semibold text-gray-500 uppercase">Nº Móvil</label>
                <input type="number" id="mobileInput" pattern="\d*" inputmode="numeric" 
                    class="w-full text-xl font-bold p-3 bg-gray-50 border-2 border-gray-200 rounded-xl focus:border-blue-500 focus:outline-none text-center placeholder-gray-300" 
                    placeholder="Ej. 101">
            </div>

            <div class="space-y-1">
                <label class="text-xs font-semibold text-gray-500 uppercase">Litros</label>
                <input type="number" id="amountInput" pattern="\d*" inputmode="decimal" 
                    class="w-full text-xl font-bold p-3 bg-gray-50 border-2 border-gray-200 rounded-xl focus:border-green-500 focus:outline-none text-center placeholder-gray-300" 
                    placeholder="0">
            </div>
        </div>

        <button onclick="addEntry()" 
            class="w-full mt-4 bg-blue-600 hover:bg-blue-700 text-white text-lg font-bold py-3 rounded-xl shadow-md flex justify-center items-center gap-2 active:scale-95 transition-transform">
            <i data-lucide="plus-circle" class="w-6 h-6"></i>
            CARGAR
        </button>
    </div>

    <!-- Lista -->
    <div class="flex-1 overflow-y-auto p-4 space-y-3 bg-gray-100" id="historyList">
        <div id="emptyState" class="flex flex-col items-center justify-center h-40 text-gray-400 opacity-60">
            <i data-lucide="fuel" class="w-12 h-12 mb-2"></i>
            <p class="text-sm">Listo para cargar</p>
        </div>
    </div>
    
    <!-- Total Footer para impresión -->
    <div class="print-only mt-4 pt-4 border-t-2 border-gray-300 text-right">
        <h2 class="text-xl font-bold">Total General: <span id="printTotal">0</span> Lts</h2>
    </div>

    <script>
        lucide.createIcons();

        let entries = [];
        
        // Elementos
        const mobileInput = document.getElementById('mobileInput');
        const amountInput = document.getElementById('amountInput');
        const displayTotal = document.getElementById('displayTotal');
        const countDisplay = document.getElementById('countDisplay');
        const historyList = document.getElementById('historyList');
        const clockDisplay = document.getElementById('clockDisplay');

        // 1. Reloj en Tiempo Real
        function updateClock() {
            const now = new Date();
            // Formato DD/MM/YYYY HH:MM:SS
            const dateStr = now.toLocaleDateString('es-PY', { day: '2-digit', month: '2-digit', year: '2-digit' });
            const timeStr = now.toLocaleTimeString('es-PY', { hour12: false });
            clockDisplay.textContent = `${dateStr} ${timeStr}`;
        }
        setInterval(updateClock, 1000);
        updateClock();

        // Cargar datos
        window.onload = () => {
            const savedData = localStorage.getItem('fuelCalcData_Rodrigo_Lts');
            if (savedData) {
                entries = JSON.parse(savedData);
                renderList();
                updateTotal();
            }
            // Intento bloquear el gesto de swipe-down a nivel de JS también
            document.body.addEventListener('touchmove', function(e) {
                if (window.scrollY === 0 && e.touches[0].clientY > 0 && e.cancelable) {
                    // Solo si estamos arriba del todo y intentamos bajar
                    // Dejamos que el CSS overscroll-behavior haga su trabajo, 
                    // pero esto es un refuerzo si el usuario desliza desde la barra de navegación.
                }
            }, { passive: false });
        };

        function addEntry() {
            const mobile = mobileInput.value.trim();
            const amount = parseFloat(amountInput.value);

            if (!mobile || !amount || isNaN(amount)) {
                if(!mobile) blinkError(mobileInput);
                if(!amount) blinkError(amountInput);
                return;
            }

            const newEntry = {
                id: Date.now(),
                mobile: mobile,
                amount: amount,
                timestamp: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' })
            };

            entries.unshift(newEntry);
            saveData();
            renderList();
            updateTotal();

            mobileInput.value = '';
            amountInput.value = '';
            mobileInput.focus();
        }

        function deleteEntry(id) {
            if(confirm('¿Borrar registro?')) {
                entries = entries.filter(entry => entry.id !== id);
                saveData();
                renderList();
                updateTotal();
            }
        }

        function resetAll() {
            if (entries.length === 0) return;
            if (confirm('¿Borrar TODO el historial?')) {
                entries = [];
                saveData();
                renderList();
                updateTotal();
            }
        }

        function updateTotal() {
            const total = entries.reduce((sum, entry) => sum + entry.amount, 0);
            displayTotal.textContent = total.toLocaleString('es-PY');
            countDisplay.textContent = entries.length;
            
            // Actualizar total para impresión
            const printEl = document.getElementById('printTotal');
            if(printEl) printEl.textContent = total.toLocaleString('es-PY');
        }

        function renderList() {
            historyList.innerHTML = '';
            if (entries.length === 0) {
                historyList.appendChild(document.getElementById('emptyState').cloneNode(true));
                return;
            }

            entries.forEach(entry => {
                const item = document.createElement('div');
                item.className = 'bg-white p-3 rounded-xl shadow-sm flex justify-between items-center border-l-4 border-blue-500 mb-2';
                item.innerHTML = `
                    <div class="flex items-center gap-3">
                        <div class="bg-blue-50 p-2 rounded-lg text-blue-600 font-bold text-lg w-14 text-center">
                            ${entry.mobile}
                        </div>
                        <div>
                            <p class="text-xs text-gray-400 font-mono">${entry.timestamp}</p>
                            <p class="text-gray-900 font-bold text-lg">${entry.amount} Lts</p>
                        </div>
                    </div>
                    <button onclick="deleteEntry(${entry.id})" class="p-2 text-gray-300 hover:text-red-500 no-print">
                        <i data-lucide="trash-2" class="w-5 h-5"></i>
                    </button>
                `;
                historyList.appendChild(item);
            });
            lucide.createIcons();
        }

        function saveData() {
            localStorage.setItem('fuelCalcData_Rodrigo_Lts', JSON.stringify(entries));
        }

        function blinkError(element) {
            element.classList.add('bg-red-50', 'border-red-500');
            setTimeout(() => element.classList.remove('bg-red-50', 'border-red-500'), 300);
            element.focus();
        }

        // 4. PDF / Imprimir
        function generatePDF() {
            // Actualizar fecha de impresión
            document.getElementById('printDate').textContent = 'Generado: ' + new Date().toLocaleString();
            window.print();
        }

        // 3. Pantalla Completa (Fullscreen API)
        function toggleFullScreen() {
            const doc = window.document;
            const docEl = doc.documentElement;

            const requestFullScreen = docEl.requestFullscreen || docEl.mozRequestFullScreen || docEl.webkitRequestFullScreen || docEl.msRequestFullscreen;
            const cancelFullScreen = doc.exitFullscreen || doc.mozCancelFullScreen || doc.webkitExitFullscreen || doc.msExitFullscreen;

            if (!doc.fullscreenElement && !doc.mozFullScreenElement && !doc.webkitFullscreenElement && !doc.msFullscreenElement) {
                if(requestFullScreen) {
                    requestFullScreen.call(docEl);
                } else {
                    alert("Tu iPhone no permite pantalla completa por botón. Por favor usa la opción 'Compartir' -> 'Agregar a Inicio' para eliminar las barras del navegador.");
                }
            } else {
                if(cancelFullScreen) {
                    cancelFullScreen.call(doc);
                }
            }
        }
        
        // Enter key support
        amountInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') addEntry(); });

    </script>
</body>
</html>
